<!-- Rephrase Game - Cleaned and Fixed -->
<!DOCTYPE html>
<html>
<head>
  <title>Rephrase Game</title>
  <style>
    body {
      font-family: "Helvetica Neue", sans-serif;
      background-color: #f7f7f7;
      color: #333;
      padding: 30px;
      max-width: 600px;
      margin: auto;
    }

    .header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    h1 {
      font-family: "Georgia", serif;
      font-size: 2.3em;
      color: #444;
      text-align: center;
      flex: 1;
    }

    #howToPlayButton {
      font-size: 0.9em;
      color: #007B8A;
      background: none;
      border: none;
      cursor: pointer;
      text-decoration: underline;
      padding: 0;
    }

    #date {
      font-size: 0.95em;
      color: #777;
      text-align: center;
      margin-bottom: 4px;
    }

    #byline {
      font-size: 0.95em;
      color: #888;
      font-style: italic;
      margin-bottom: 10px;
      text-align: center;
    }

    #timer {
      text-align: center;
      margin-top: 10px;
      font-weight: bold;
      font-size: 1em;
    }

    #phrase {
      font-size: 1.3em;
      font-weight: bold;
      background: #ececec;
      padding: 12px 16px;
      border-radius: 12px;
      margin-bottom: 20px;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    #letterPool {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(32px, 1fr));
      gap: 8px;
      padding: 12px;
      border-radius: 12px;
      background: #fdfdf5;
      border: 1px solid #ccc;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
      margin-bottom: 20px;
      justify-items: center;
    }

    .letter-tile {
      display: flex;
      justify-content: center;
      align-items: center;
      width: 32px;
      height: 32px;
      background: white;
      border-radius: 6px;
      font-weight: bold;
      font-size: 1.1em;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
      border: 1px solid #ddd;
    }

    #input {
      width: calc(100% - 20px);
      font-size: 1em;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #ccc;
      margin-bottom: 5px;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
    }

    #errorMessage {
      color: red;
      font-size: 0.9em;
      margin-bottom: 10px;
      display: none;
    }

    .button-row {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 10px;
    }

    button {
      background: #c8d6d4;
      color: #222;
      font-weight: bold;
      padding: 10px 16px;
      font-size: 0.95em;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: background 0.2s;
    }

    button:hover {
      background: #b1c4c1;
    }

    #words {
      list-style: none;
      padding-left: 0;
      margin-top: 20px;
    }

    #words li {
      background: #e0e0e0;
      padding: 8px 12px;
      border-radius: 10px;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .remove-btn {
      background: none;
      color: #888;
      border: none;
      font-size: 1em;
      cursor: pointer;
      padding: 0 6px;
      transition: color 0.2s;
    }

    .remove-btn:hover {
      color: #c00;
    }

    #progress {
      margin-top: 20px;
      font-weight: bold;
      display: none;
      text-align: center;
    }

    #winMessage {
      display: none;
      margin-top: 20px;
      font-weight: bold;
      font-size: 1.1em;
      color: green;
      text-align: center;
    }
    .space-tile {
      background: transparent;
      border: none;
      box-shadow: none;
      width: 16px;
      height: 32px;
    }
    #shareBtn {
      display: none;
      margin-top: 10px;
      margin-left: auto;
      margin-right: auto;
    }

    #instructionBox {
      display: none;
      background: #f0f7f7;
      color: #333;
      border: 1px solid #b1c4c1;
      border-radius: 10px;
      padding: 16px;
      margin-bottom: 20px;
      font-size: 0.95em;
    }

    #instructionBox ul {
      padding-left: 20px;
      margin: 0;
    }
  </style>
</head>
<body>

  <div class="header-row" style="margin-bottom: 0.2em;">
    <div style="width: 33%; text-align: left;">
      <button id="archiveButton" onclick="goToArchive()" style="background: none; border: none; color: #007B8A; font-size: 0.95em; cursor: pointer; text-decoration: underline;">
        Archive
      </button>
    </div>
    <h1>Rephrase</h1>
    <div style="width: 33%; text-align: right;">
      <button id="howToPlayButton" onclick="toggleInstructions()">How to Play</button>
    </div>
  </div>
  <div id="date">Puzzle #{{ puzzle_number }} • {{ date }}</div>
  <div id="byline">By Chase Dittrich</div>
  <div id="timer"></div>

  <div id="instructionBox">
    <strong>Welcome to Rephrase!</strong><br><br>
    Rearrange all the letters from the given phrase into new, valid words.<br><br>
    <ul>
      <li>Use all the letters to win.</li>
      <li>Words must be at least 3 letters long.</li>
      <li>You can’t reuse letters or use words from the original phrase.</li>
      <li>Partial progress is tracked — see how close you can get!</li>
    </ul>
  </div>

 
  <div id="letterPool"></div>

  <input id="input" type="text" placeholder="Enter word" onkeydown="handleKey(event)" />
  <div id="errorMessage"></div>

  <div class="button-row">
    <button onclick="submitWord()">Submit</button>
    <button onclick="shuffleLetters()">Shuffle </button>
    <button onclick="giveUp()">Give Up</button>
  </div>

  <ul id="words"></ul>
  <div id="progress">0% used (0/?)</div>

  <div id="winMessage">🎉 You used all the letters! Perfect score!</div>
  <button id="shareBtn" onclick="shareResult()">Share Result</button>
  <div id="copyConfirm" style="display: none; text-align: center; color: green; margin-top: 6px; font-size: 0.9em;">
    Results copied to clipboard!
  </div>

  <script>
    let words = [];
    let gaveUp = false;

    const giveUpMessages = [
      "You gave up. Maybe tomorrow's phrase will feel easier!",
      "You threw in the towel. It happens to the best of us.",
      "You're calling it quits. Respect.",
      "You waved the white flag. We'll allow it.",
      "Not today! Try again tomorrow.",
      "You surrendered with honor. A noble retreat.",
      "You gave up. At least you got some words in!"
    ];

    function toggleInstructions() {
      const box = document.getElementById('instructionBox');
      box.style.display = box.style.display === 'none' ? 'block' : 'none';
    }

    async function updateProgress() {
      if (words.length === 0) {
        renderLetterPool();
        document.getElementById('progress').style.display = 'none';  // Hide it
        return;
      }

      const res = await fetch('/progress', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ words })
      });

      const j = await res.json();

      if (j.ok) {
        if (words.length > 0) {
          document.getElementById('progress').style.display = 'block';
          document.getElementById('progress').innerText =
            j.percent + '% of letters used (' + j.used_letters + '/' + j.total_letters + ')';
        }
        if (j.percent === 100 && words.length > 0) {
          stopTimer();
          document.getElementById('winMessage').style.display = 'block';
          document.getElementById('winMessage').innerText =
            `🎉 You used all the letters! Perfect score in ${words.length} words!`;
          document.getElementById('shareBtn').style.display = 'inline-block';
        }
      } else {
        showInvalidInput(j.message);
      }

      renderLetterPool();
    }
    async function loadArchive() {
      const day = document.getElementById("archiveSelect").value;
      if (!day) return;

      const res = await fetch(`/archive/${day}`);
      if (!res.ok) {
        alert("Could not load puzzle.");
        return;
      }

      const puzzle = await res.json();
      // Reset everything
      words = [];
      gaveUp = false;
      startTime = null;
      finalTime = null;
      clearInterval(timerInterval);

      // Update the interface
      document.getElementById('input').style.display = 'inline-block';
      document.querySelector('.button-row').style.display = 'flex';
      document.getElementById('winMessage').style.display = 'none';
      document.getElementById('shareBtn').style.display = 'none';
      document.getElementById('copyConfirm').style.display = 'none';
      document.getElementById('progress').style.display = 'none';

      // Update globals
      window.puzzleLetters = puzzle.letters;
      window.originalPhrase = puzzle.phrase;

      // Update display
      renderLetterPool(puzzle.phrase);
      renderWordList();
      updateTimerDisplay();
      startTimer();
    }

    async function submitWord() {
      document.getElementById('errorMessage').style.display = 'none';
      const w = document.getElementById('input').value.trim();
      if (!w) return;

      const res = await fetch('/submit', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ word: w })
      });

      const j = await res.json();

      if (j.ok) {
        words.push(w);
        renderWordList();
        await updateProgress();
      } else {
        showInvalidInput(j.message);
        // Do NOT add the word, do NOT call updateProgress
      }

      document.getElementById('input').value = '';
    }
    function goToArchive() {
      window.location.href = "/archive.html";
    }
    function renderLetterPool() {
      const phrase = (window.originalPhrase || "{{ phrase|lower }}").toLowerCase();
      const cleanedPhrase = phrase.replace(/[^a-z\s]/g, '');  // Keep letters and spaces
      const letterCounts = {};
      const poolTiles = [];

      for (let letter of cleanedPhrase) {
        if (letter === ' ') {
          poolTiles.push('<div class="letter-tile space-tile"></div>'); // Spacer tile
        } else {
          letterCounts[letter] = (letterCounts[letter] || 0) + 1;
          poolTiles.push(`<div class="letter-tile">${letter.toUpperCase()}</div>`);
        }
      }

      for (let word of words) {
        for (let letter of word.toLowerCase()) {
          for (let i = 0; i < poolTiles.length; i++) {
            if (
              poolTiles[i].includes(`>${letter.toUpperCase()}<`)
            ) {
              poolTiles[i] = '';  // remove used letter
              break;
            }
          }
        }
      }

      document.getElementById("letterPool").innerHTML = poolTiles.filter(Boolean).join('');
    }

    function renderWordList() {
      document.getElementById('words').innerHTML =
        words.map((x, i) =>
          `<li>${x} <button class="remove-btn" onclick="removeWord(${i})">✕</button></li>`
        ).join('');
    }

    function removeWord(index) {
      words.splice(index, 1);
      renderWordList();
      updateProgress();
    }

    function handleKey(e) {
      if (e.key === 'Enter') submitWord();
    }

    function showInvalidInput(msg) {
      const errorDiv = document.getElementById('errorMessage');
      errorDiv.innerText = msg;
      errorDiv.style.display = 'block';

      setTimeout(() => {
        errorDiv.style.display = 'none';
      }, 2500);
    }

    function shuffleLetters() {
      const pool = Array.from(document.querySelectorAll('.letter-tile'))
        .map(tile => tile.innerText);

      for (let i = pool.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [pool[i], pool[j]] = [pool[j], pool[i]];
      }

      let output = "";
      for (let letter of pool) {
        output += `<div class="letter-tile">${letter}</div>`;
      }

      document.getElementById("letterPool").innerHTML = output;
    }

    function giveUp() {
      gaveUp = true;
      stopTimer();  // 🛑 Add this line to stop the timer immediately
      const randomMessage =
        giveUpMessages[Math.floor(Math.random() * giveUpMessages.length)];

      document.getElementById('winMessage').style.display = 'block';
      document.getElementById('winMessage').innerText =
        `${randomMessage} You used ${words.length} word${words.length !== 1 ? 's' : ''}.`;

      document.getElementById('shareBtn').style.display = 'inline-block';
      document.getElementById('input').style.display = 'none';
      document.querySelector('.button-row').style.display = 'none';

      updateProgress();
    }

    let startTime = null;
    let timerInterval = null;
    let finalTime = null;

    function startTimer() {
      startTime = Date.now();
      timerInterval = setInterval(updateTimerDisplay, 1000);
    }

    function stopTimer() {
      if (timerInterval) {
        clearInterval(timerInterval);
        finalTime = Math.floor((Date.now() - startTime) / 1000);
        updateTimerDisplay(true);
      }
    }

    function updateTimerDisplay(force = false) {
      const now = Date.now();
      const seconds = force ? finalTime : Math.floor((now - startTime) / 1000);
      const minutes = Math.floor(seconds / 60);
      const remainingSeconds = seconds % 60;

      document.getElementById("timer").innerText =
        `⏱ Time: ${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
    }

    function shareResult() {
      const phrase = "{{ phrase }}";
      const number = {{ puzzle_number }};
      const count = words.length;
      const progressText = document.getElementById("progress").innerText;

      let timeDisplay = "⏱ Time: N/A";
      if (finalTime !== null) {
        const minutes = Math.floor(finalTime / 60);
        const seconds = finalTime % 60;
        timeDisplay = `⏱ Time: ${minutes}:${seconds.toString().padStart(2, '0')}`;
      }

      const result = `🟩 Rephrase #${number}
    ${progressText}
    📝 ${count} word${count !== 1 ? 's' : ''}
    ${timeDisplay}
    💬 Phrase: “${phrase}”`;

      navigator.clipboard.writeText(result).then(() => {
        const msg = document.getElementById('copyConfirm');
        msg.style.display = 'block';
        setTimeout(() => {
          msg.style.display = 'none';
        }, 2500);
      });
    }
    function goToArchive() {
      window.location.href = '/archive';
    }
    renderLetterPool();
    renderWordList();
    updateProgress();
    startTimer();
  </script>
</body>
</html>
