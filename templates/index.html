<!-- Rephrase Game - Cleaned and Fixed -->
<!DOCTYPE html>
<html>
<head>
  <title>Rephrase Game</title>
  <style>
    body {
      font-family: "Helvetica Neue", sans-serif;
      background-color: #f7f7f7;
      color: #333;
      padding: 30px;
      max-width: 600px;
      margin: auto;
    }

    .header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    h1 {
      font-family: "Georgia", serif;
      font-size: 2.3em;
      color: #444;
      text-align: center;
      flex: 1;
    }

    #howToPlayButton {
      font-size: 0.9em;
      color: #007B8A;
      background: none;
      border: none;
      cursor: pointer;
      text-decoration: underline;
      padding: 0;
    }

    #date {
      font-size: 0.95em;
      color: #777;
      text-align: center;
      margin-bottom: 4px;
    }

    #byline {
      font-size: 0.95em;
      color: #888;
      font-style: italic;
      margin-bottom: 10px;
      text-align: center;
    }

    #timer {
      text-align: center;
      margin-top: 10px;
      font-weight: bold;
      font-size: 1em;
    }

    #phrase {
      font-size: 1.3em;
      font-weight: bold;
      background: #ececec;
      padding: 12px 16px;
      border-radius: 12px;
      margin-bottom: 20px;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    #letterPool {
      display: flex;
      flex-wrap: wrap; /* Allow wrapping of words to next line */
      gap: 8px; /* Space between words */
      padding: 12px;
      border-radius: 12px;
      background: #fdfdf5;
      border: 1px solid #ccc;
      box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
      margin-bottom: 20px;
      justify-content: flex-start;
    }

    .word-tile {
      display: inline-flex;
      gap: 8px; /* Space between letters within the word */
      flex-wrap: nowrap; /* Prevent word from wrapping */
      white-space: nowrap; /* Prevent word from breaking */
    }

    .letter-tile {
      display: inline-flex;
      justify-content: center;
      align-items: center;
      width: 32px;
      height: 32px;
      background: white;
      border-radius: 6px;
      font-weight: bold;
      font-size: 1.1em;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      border: 1px solid #ddd;
    }


    #input {
      width: calc(100% - 20px);
      font-size: 1em;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #ccc;
      margin-bottom: 5px;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
    }

    #errorMessage {
      color: red;
      font-size: 0.9em;
      margin-bottom: 10px;
      display: none;
    }

    .button-row {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 10px;
    }

    button {
      background: #c8d6d4;
      color: #222;
      font-weight: bold;
      padding: 10px 16px;
      font-size: 0.95em;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: background 0.2s;
    }

    button:hover {
      background: #b1c4c1;
    }

    #words {
      list-style: none;
      padding-left: 0;
      margin-top: 20px;
    }

    #words li {
      background: #e0e0e0;
      padding: 8px 12px;
      border-radius: 10px;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #progress {
      margin-top: 20px;
      font-weight: bold;
      display: none;
      text-align: center;
    }

    #winMessage {
      display: none;
      margin-top: 20px;
      font-weight: bold;
      font-size: 1.1em;
      color: green;
      text-align: center;
    }
    .space-tile {
      background: transparent;
      border: none;
      box-shadow: none;
      width: 16px;
      height: 32px;
    }
    #shareBtn {
      display: none;
      margin-top: 10px;
      margin-left: auto;
      margin-right: auto;
    }

    #instructionBox {
      display: none;
      background: #f0f7f7;
      color: #333;
      border: 1px solid #b1c4c1;
      border-radius: 10px;
      padding: 16px;
      margin-bottom: 20px;
      font-size: 0.95em;
    }

    #instructionBox ul {
      padding-left: 20px;
      margin: 0;
    }
    .badge {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 1.2em;
      font-weight: bold;
      background-color: rgba(0, 255, 0, 0.8); /* Light green background */
      color: white;
      padding: 10px 20px;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
      opacity: 0;
      animation: fadeInOut 2s forwards;
    }

    @keyframes fadeInOut {
      0% {
        opacity: 0;
      }
      25% {
        opacity: 1;
      }
      75% {
        opacity: 1;
      }
      100% {
        opacity: 0;
      }
    }
    .word-tile {
      position: relative;  /* Ensure the badge is positioned relative to the word box */
      display: flex;  /* Use flexbox for better alignment */
      justify-content: space-between;  /* Space between the badge and X button */
      align-items: center;  /* Vertically center the elements */
      white-space: nowrap;  /* Prevent word from breaking */
      gap: 8px;  /* Space between the letters and elements */
    }

    .word-badge {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      font-size: 0.8em;
      font-weight: bold;
      color: #ffffff;  /* Pale off-white text */
      padding: 5px 10px;
      border-radius: 50%;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      z-index: 10;
    }

    .word-badge.badge-7plus {
      background-color: #d69f1f;  /* Muted gold-orange for 7+ badge */
    }

    .word-badge.badge-5plus {
      background-color: #9b3b55;  /* Dark magenta for 5+ badge */
    }

    .remove-btn {
      background: none;
      color: #888;
      border: none;
      font-size: 1em;
      cursor: pointer;
      padding: 0 6px;
      transition: color 0.2s;
      position: relative;  /* Position it inside the word tile */
      margin-left: auto;  /* Push the X button to the far right */
    }

    .remove-btn:hover {
      color: #c00;
    }


  </style>
</head>
<body>

  <div class="header-row" style="margin-bottom: 0.2em;">
    <div style="width: 33%; text-align: left;">
      <button id="archiveButton" onclick="goToArchive()" style="background: none; border: none; color: #007B8A; font-size: 0.95em; cursor: pointer; text-decoration: underline;">
        Archive
      </button>
    </div>
    <h1>Rephrase</h1>
    <div style="width: 33%; text-align: right;">
      <button id="howToPlayButton" onclick="toggleInstructions()">How to Play</button>
    </div>
  </div>
  <div id="date">Puzzle #{{ puzzle_number }} â€¢ {{ date }}</div>
  <div id="byline">By Chase Dittrich</div>
  <div id="timer"></div>

  <div id="instructionBox">
    <strong>Welcome to Rephrase!</strong><br><br>
    Rearrange all the letters from the given phrase into new, valid words.<br><br>
    <ul>
      <li>Use all the letters to win.</li>
      <li>Words must be at least 3 letters long.</li>
      <li>You canâ€™t reuse letters or use words from the original phrase.</li>
      <li>Partial progress is tracked â€” see how close you can get!</li>
    </ul>
  </div>

 
  <div id="letterPool"></div>

  <input id="input" type="text" placeholder="Enter word" onkeydown="handleKey(event)" />
  <div id="errorMessage"></div>

  <div class="button-row">
    <button onclick="submitWord()">Submit</button>
    <button onclick="shuffleLetters()">Shuffle </button>
    <button onclick="giveUp()">Give Up</button>
  </div>

  <ul id="words"></ul>
  <div id="progress">0% used (0/?)</div>

  <div id="winMessage">ðŸŽ‰ You used all the letters! Perfect score!</div>
  <button id="shareBtn" onclick="shareResult()">Share Result</button>
  <div id="copyConfirm" style="display: none; text-align: center; color: green; margin-top: 6px; font-size: 0.9em;">
    Results copied to clipboard!
  </div>

  <script>
    let words = [];
    let gaveUp = false;

    const giveUpMessages = [
      "You gave up. Maybe tomorrow's phrase will feel easier!",
      "You threw in the towel. It happens to the best of us.",
      "You're calling it quits. Respect.",
      "You waved the white flag. We'll allow it.",
      "Not today! Try again tomorrow.",
      "You surrendered with honor. A noble retreat.",
      "You gave up. At least you got some words in!"
    ];

    function toggleInstructions() {
      const box = document.getElementById('instructionBox');
      box.style.display = box.style.display === 'none' ? 'block' : 'none';
    }

    async function updateProgress() {
      if (words.length === 0) {
        renderLetterPool();
        document.getElementById('progress').style.display = 'none';  // Hide it
        return;
      }

      const res = await fetch('/progress', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ words })
      });

      const j = await res.json();

      if (j.ok) {
        if (words.length > 0) {
          document.getElementById('progress').style.display = 'block';
          document.getElementById('progress').innerText =
            j.percent + '% of letters used (' + j.used_letters + '/' + j.total_letters + ')';
        }
        if (j.percent === 100 && words.length > 0) {
          stopTimer();
          document.getElementById('winMessage').style.display = 'block';
          document.getElementById('winMessage').innerText =
            `ðŸŽ‰ You used all the letters! Perfect score in ${words.length} words!`;
          document.getElementById('shareBtn').style.display = 'inline-block';
        }
      } else {
        showInvalidInput(j.message);
      }

      renderLetterPool();
    }
    async function loadArchive() {
      const day = document.getElementById("archiveSelect").value;
      if (!day) return;

      const res = await fetch(`/archive/${day}`);
      if (!res.ok) {
        alert("Could not load puzzle.");
        return;
      }

      const puzzle = await res.json();
      // Reset everything
      words = [];
      gaveUp = false;
      startTime = null;
      finalTime = null;
      clearInterval(timerInterval);

      // Update the interface
      document.getElementById('input').style.display = 'inline-block';
      document.querySelector('.button-row').style.display = 'flex';
      document.getElementById('winMessage').style.display = 'none';
      document.getElementById('shareBtn').style.display = 'none';
      document.getElementById('copyConfirm').style.display = 'none';
      document.getElementById('progress').style.display = 'none';

      // Update globals
      window.puzzleLetters = puzzle.letters;
      window.originalPhrase = puzzle.phrase;

      // Update display
      renderLetterPool(puzzle.phrase);
      renderWordList();
      updateTimerDisplay();
      startTimer();
    }

    async function submitWord() {
      // Clear any previous error message
      document.getElementById('errorMessage').style.display = 'none';

      // Get the word entered by the user and trim any spaces
      const w = document.getElementById('input').value.trim();
      if (!w) return;

      // Get the original phrase and prepare it for plural check
      const phrase = (window.originalPhrase || "{{ phrase|lower }}").toLowerCase();
      const phraseWords = new Set(phrase.split(/\s+/));  // Split the phrase into words

      // If the word is plural and its singular version is in the phrase, reject it
      if (w.length > 3 && w.endsWith('s')) {
        const singularWord = w.slice(0, -1);  // Remove the "s" to get the singular version
        if (phraseWords.has(singularWord)) {
          showInvalidInput(`The plural form '${w}' is not allowed because the singular form '${singularWord}' is in the phrase.`);
          return;  // Prevent the word from being entered
        }
      }

      // Get the letter pool from the DOM
      const letterPool = Array.from(document.querySelectorAll('.letter-tile'))
        .map(tile => tile.innerText.toLowerCase());  // Get available letters in the pool

      // Count the letters in the pool
      const poolLetterCounts = letterPool.reduce((counts, letter) => {
        counts[letter] = (counts[letter] || 0) + 1;
        return counts;
      }, {});

      // Check if the word uses only letters in the pool and doesn't exceed the available count
      const wordLetterCounts = Array.from(w.toLowerCase()).reduce((counts, letter) => {
        counts[letter] = (counts[letter] || 0) + 1;
        return counts;
      }, {});

      // Validate the word against the pool
      for (let letter in wordLetterCounts) {
        if (!poolLetterCounts[letter] || wordLetterCounts[letter] > poolLetterCounts[letter]) {
          showInvalidInput(`Letter '${letter.toUpperCase()}' is not in the pool or overused.`);
          return;  // Immediately stop if there's an invalid letter
        }
      }

      // Send the word to the server for further validation
      const res = await fetch('/submit', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ word: w })
      });

      const j = await res.json();

      if (j.ok) {
        words.push(w);  // Only add the word if the server validates it as okay
        renderWordList();
        await updateProgress();

        // Find the word entry element after it's added to the list
        const wordElement = document.querySelector(`#word-${words.length - 1}`);

        // Ensure the wordElement exists before proceeding
        if (!wordElement) {
          console.error(`Word element #word-${words.length - 1} not found!`);
          return;  // Exit early if wordElement doesn't exist
        }

        // Display badge next to the word based on word length
        if (w.length >= 7) {
          addBadge(wordElement, "7+");
        } else if (w.length >= 5) {
          addBadge(wordElement, "5+");
        }
      } else {
        showInvalidInput(j.message);  // Handle server-side validation errors
      }

      document.getElementById('input').value = '';  // Clear input after submission
    }

    function addBadge(wordElement, badgeType) {
      // Safe name for badge to avoid issues with special characters like '+'
      const safeBadgeType = 'badge-' + badgeType.replace('+', 'plus');
      console.log(`Adding badge: ${safeBadgeType}`);

      // Check if the badge already exists for this word to prevent duplicates
      const existingBadge = wordElement.querySelector(`.word-badge.${safeBadgeType}`);
      console.log(existingBadge);  // Log existing badge to check

      if (!existingBadge) {
        const badge = document.createElement("div");
        badge.className = `word-badge ${safeBadgeType}`;
        badge.innerText = badgeType;

        console.log("Badge created:", badge);  // Log badge creation

        // Append the badge inside the word element without removing any existing badges
        wordElement.appendChild(badge);  // Add badge to the same word element
      }
    }
    


    function showBadge(message) {
      const badge = document.createElement("div");
      badge.className = "badge";
      badge.innerText = message;

      // Append the badge to the body or another container
      document.body.appendChild(badge);

      // Remove the badge after a short delay (e.g., 2 seconds)
      setTimeout(() => {
        badge.remove();
      }, 2000); // 2 seconds
    }
    function goToArchive() {
      window.location.href = "/archive.html";
    }
    function renderLetterPool() {
      const phrase = (window.originalPhrase || "{{ phrase|lower }}").toLowerCase();
      const cleanedPhrase = phrase.replace(/[^a-z\s]/g, '');  // Keep letters and spaces
      const letterCounts = {};
      const poolTiles = [];

      for (let letter of cleanedPhrase) {
        if (letter === ' ') {
          poolTiles.push('<div class="letter-tile space-tile"></div>'); // Spacer tile
        } else {
          letterCounts[letter] = (letterCounts[letter] || 0) + 1;
          poolTiles.push(`<div class="letter-tile">${letter.toUpperCase()}</div>`);
        }
      }

      for (let word of words) {
        for (let letter of word.toLowerCase()) {
          for (let i = 0; i < poolTiles.length; i++) {
            if (
              poolTiles[i].includes(`>${letter.toUpperCase()}<`)
            ) {
              poolTiles[i] = '';  // remove used letter
              break;
            }
          }
        }
      }

      document.getElementById("letterPool").innerHTML = poolTiles.filter(Boolean).join('');
    }

    function renderWordList() {
      document.getElementById('words').innerHTML =
        words.map((x, i) =>
          `<li id="word-${i}">${x} <button class="remove-btn" onclick="removeWord(${i})">âœ•</button></li>`
        ).join('');
    }

    function removeWord(index) {
      words.splice(index, 1);
      renderWordList();
      updateProgress();
    }

    function handleKey(e) {
      if (e.key === 'Enter') submitWord();
    }

    function showInvalidInput(msg) {
      const errorDiv = document.getElementById('errorMessage');
      errorDiv.innerText = msg;
      errorDiv.style.display = 'block';

      setTimeout(() => {
        errorDiv.style.display = 'none';
      }, 2500);
    }

    function shuffleLetters() {
      const pool = Array.from(document.querySelectorAll('.letter-tile'))
        .map(tile => tile.innerText);

      for (let i = pool.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [pool[i], pool[j]] = [pool[j], pool[i]];
      }

      let output = "";
      for (let letter of pool) {
        output += `<div class="letter-tile">${letter}</div>`;
      }

      document.getElementById("letterPool").innerHTML = output;
    }

    function giveUp() {
      gaveUp = true;
      stopTimer();  // ðŸ›‘ Add this line to stop the timer immediately
      const randomMessage =
        giveUpMessages[Math.floor(Math.random() * giveUpMessages.length)];

      document.getElementById('winMessage').style.display = 'block';
      document.getElementById('winMessage').innerText =
        `${randomMessage} You used ${words.length} word${words.length !== 1 ? 's' : ''}.`;

      document.getElementById('shareBtn').style.display = 'inline-block';
      document.getElementById('input').style.display = 'none';
      document.querySelector('.button-row').style.display = 'none';

      updateProgress();
    }

    let startTime = null;
    let timerInterval = null;
    let finalTime = null;

    function startTimer() {
      startTime = Date.now();
      timerInterval = setInterval(updateTimerDisplay, 1000);
    }

    function stopTimer() {
      if (timerInterval) {
        clearInterval(timerInterval);
        finalTime = Math.floor((Date.now() - startTime) / 1000);
        updateTimerDisplay(true);
      }
    }

    function updateTimerDisplay(force = false) {
      const now = Date.now();
      const seconds = force ? finalTime : Math.floor((now - startTime) / 1000);
      const minutes = Math.floor(seconds / 60);
      const remainingSeconds = seconds % 60;

      document.getElementById("timer").innerText =
        `â± Time: ${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
    }

    function shareResult() {
      const phrase = "{{ phrase }}";
      const number = {{ puzzle_number }};
      const count = words.length;
      const progressText = document.getElementById("progress").innerText;

      let timeDisplay = "â± Time: N/A";
      if (finalTime !== null) {
        const minutes = Math.floor(finalTime / 60);
        const seconds = finalTime % 60;
        timeDisplay = `â± Time: ${minutes}:${seconds.toString().padStart(2, '0')}`;
      }

      const result = `ðŸŸ© Rephrase #${number}
    ${progressText}
    ðŸ“ ${count} word${count !== 1 ? 's' : ''}
    ${timeDisplay}
    ðŸ’¬ Phrase: â€œ${phrase}â€`;

      navigator.clipboard.writeText(result).then(() => {
        const msg = document.getElementById('copyConfirm');
        msg.style.display = 'block';
        setTimeout(() => {
          msg.style.display = 'none';
        }, 2500);
      });
    }
    function goToArchive() {
      window.location.href = '/archive';
    }
    renderLetterPool();
    renderWordList();
    updateProgress();
    startTimer();
  </script>
</body>
</html>
